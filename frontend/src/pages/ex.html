<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .hidden {
            display: none;
        }
        canvas {
            background: #eee;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>Welcome to Room</h1>
    <canvas id="gameCanvas" class="hidden" width="1024" height="768"></canvas>

    <!-- 매칭하기 섹션 -->
    <div id="matchingSection">
        <button onclick="requestMatching()">매칭하기</button>
        
    </div>
    <div id="cancelSection">
        <button onclick="cancelMatching()">매칭취소</button>
    </div>

    <div id="msg"></div>
    
    <script>
        const canvas =document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket= io();

        let myPlayer = { id: null, x: canvas.width / 2, y: canvas.height / 2, color: '#FF5733' };
        let otherPlayer=null;
        let roomName=null;

        
        const mode = localStorage.getItem('mode');
        const difficulty = localStorage.getItem('difficulty');
        const member_id = localStorage.getItem('member_id');

        //매칭 요청
        function requestMatching() {
            socket.emit("matching", { mode, difficulty,member_id });
        }

        // 매칭 취소 및 소켓 연결 종료
        function cancelMatching() {
            //socket.emit("cancelMatching"); // 매칭 취소 요청
            socket.disconnect(); // 소켓 연결 종료
            console.log("매칭 취소 요청 및 소켓 연결 종료");
            window.location.href = "/"; // /로 리다이렉트
        }

        socket.on("opponentDisconnected", () => {
        alert("상대가 접속을 종료했습니다."); 
        });


        // 매칭 성공 처리
        socket.on("matched", (assignedRoomName,data) => {
            roomName = assignedRoomName;

            // 상대방 초기 데이터 설정
            myPlayer = data.myPlayer;
            otherPlayer = data.otherPlayer;

            // 매칭 섹션 숨김
            document.getElementById("matchingSection").classList.add("hidden");
            // 캔버스 표시
            canvas.classList.remove("hidden");

            // 상대방과 매칭 성공 메시지 표시
            const opponentMemberId = otherPlayer.member_id;
            const msg = `${opponentMemberId}님과 매칭에 성공하였습니다.`;
            const msgElement = document.createElement("p");
            msgElement.textContent = msg;
            document.getElementById("msg").appendChild(msgElement);

            console.log(`Matched in room: ${roomName}`);
            console.log("My Player:", myPlayer);
            console.log("Other Player:", otherPlayer);

        });

        // 서버로부터 상대방 데이터 수신
        socket.on("updatePlayers", (data) => {
            // 서버에서 받은 플레이어 데이터가 자신이 아닌 경우
            if (data.id !== myPlayer.id) {
                if (!otherPlayer) {
                    otherPlayer = { id: data.id, x: data.x, y: data.y, color: "#3355FF" };
                } else {
                    otherPlayer.x = data.x;
                    otherPlayer.y = data.y;
                }
             }
        });

        

        // 키 입력 상태
        const keys = { up: false, down: false, left: false, right: false };
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowUp') keys.up = true;
            if (e.code === 'ArrowDown') keys.down = true;
            if (e.code === 'ArrowLeft') keys.left = true;
            if (e.code === 'ArrowRight') keys.right = true;
        });
        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowUp') keys.up = false;
            if (e.code === 'ArrowDown') keys.down = false;
            if (e.code === 'ArrowLeft') keys.left = false;
            if (e.code === 'ArrowRight') keys.right = false;
        });

        // 위치 업데이트 및 서버로 전송
        function updatePosition() {
            if (keys.up && myPlayer.y > 0) myPlayer.y -= 5;
            if (keys.down && myPlayer.y < canvas.height) myPlayer.y += 5;
            if (keys.left && myPlayer.x > 0) myPlayer.x -= 5;
            if (keys.right && myPlayer.x < canvas.width) myPlayer.x += 5;

            socket.emit("updatePosition", { roomName, player: myPlayer });
        }

        // 플레이어 렌더링
        function renderPlayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 내 플레이어
            ctx.beginPath();
            ctx.arc(myPlayer.x, myPlayer.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = myPlayer.color;
            ctx.fill();
            ctx.closePath();

            // 상대 플레이어
            if (otherPlayer) {
                ctx.beginPath();
                ctx.arc(otherPlayer.x, otherPlayer.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = otherPlayer.color;
                ctx.fill();
                ctx.closePath();
            }
        }

        // 게임 루프
        function gameLoop() {
            updatePosition();
            renderPlayers();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();

    </script>

</body>
</html>
